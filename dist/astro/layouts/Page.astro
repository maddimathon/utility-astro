---
/**
 * 
 * 
 * @package boilerplate-astro-project@0.1.0-alpha.draft
 * @since 0.1.0-alpha.draft
 */

/* import - types */
import type {
    Objects,
} from '@maddimathon/utility-typescript/types';

import type { Props as NavMenuProps } from '../components/NavMenu.d.ts';
import type {
    Props as ContentProps,
    Props_Full as ContentProps_Full,
    ContentType
} from './Content.astro';
import type { Props } from './Page.d.ts';

/* import - functions */
import { DateTime } from 'luxon';
import { mergeArgs, slugify } from '@maddimathon/utility-typescript/functions';
import { FeatureCheck } from '@maddimathon/utility-sass';

import { currentPagePath } from '../functions/index.js';
import { mapToObject } from '../../ts/01-functions/mapToObject.js';
import Toggle_Scripts from '../support/Toggle_Scripts.astro';

/* import - values */

/* import - layouts */
import Content from './Content.astro';

/* import - components */
import Page_Meta from '../components/Page_Meta.astro';
import SkipLinks from '../components/SkipLinks.astro';
import NavMenu from '../components/NavMenu.astro';
import SettingsMenu from '../components/SettingsMenu.astro';


/** ## PROPS ==================================== **/

export type { Props };
export type * from './Page.d.ts';

const p: Props<ContentType> = Astro.props.frontmatter ?? Astro.props;


/* ### Content Props ------------------ */

const _defContent: ContentProps<ContentType> & ContentProps_Full<ContentType> = {

    type: p.layout || 'content-only',

    title: Array.isArray(p.title)
        ? ( p.title.length ? p.title:[] ) 
        : ( p.title.length ? [p.title]:[] ),

    subtitle: p.subtitle || null,

    attrs: {
        main: {},
        sidebar: {},
    },
};

const content = mergeArgs(_defContent, p.content, true);


/** ## CONSTANTS ==================================== **/

const pageSlug: string = slugify( currentPagePath( Astro.url ) ) || 'home';

const SiteTitleTag = ( content.title && content.title.length ) ? 'p' : 'h1';


/* ### Nav Menus ------------------ */

/**
 * The menu params constructed from input props.
 */
const menus: {
    primary?: NavMenuProps;
    secondary?: NavMenuProps;
} = {};

if ( p.primaryMenu ) {

    let _menu: Objects.PartialExcept<NavMenuProps, "menu">;
    
    if ( Array.isArray( p.primaryMenu ) ) {
        _menu = {
            menu: p.primaryMenu,
        }
    } else {
        _menu = p.primaryMenu;
    }

    menus.primary = {
        'aria-label': 'Primary Menu',
        id: 'primary-menu',
        ..._menu,
    };
}

if ( p.secondaryMenu ) {

    let _menu: Objects.PartialExcept<NavMenuProps, "menu">;
    
    if ( Array.isArray( p.secondaryMenu ) ) {
        _menu = {
            menu: p.secondaryMenu,
        }
    } else {
        _menu = p.secondaryMenu;
    }

    menus.secondary = {
        'aria-label': 'Secondary Menu',
        id: 'secondary-menu',
        ..._menu,
    };
}


/* ### Support ------------------ */

const support = mergeArgs(
    {
        elementToggle: true,
        featureCheck: true,
        settings: true,
    },
    p.support,
);


/* ### Slots ------------------ */

/**
 * Rendered slot HTML.
 */
const slots_render = mapToObject(
    await Promise.all(
        ( [
            'afterFooter',
            'afterHeader',
            'afterPrimaryNav',
            'afterSecondaryNav',
            'beforeFooter',
            'beforeHeader',
            'beforePrimaryNav',
            'beforeSecondaryNav',
            'bodyClose',
            'bodyOpen',
            'footer',
            'footerScripts',
            'headClose',
            'header',
            'headOpen',
        ] as const ).map( async ( _key ) => {

            const _kebab = _key.replace(
                /([a-z0-9])([A-Z])/g,
                ( _v, _cap1, _cap2 ) => _cap1 + '-' + _cap2.toLowerCase()
            );

            return [
                _key,
                Astro.slots.has( _kebab ) && await Astro.slots.render( _kebab ) || false
            ] as const
        } )
    )
);


/* ### Include ------------------ */

/**
 * Sections/components to include or not.
 */
const include = {
    
    footer: p.footer && ( 
        p.footer.copyright
        || p.footer.designedBy
        || slots_render.footer
    ),
    
    header: p.header && ( 
        p.header.title 
        || p.header.tagline
        || slots_render.header
    ),
};


/* ### Preformatted ------------------ */

const today = DateTime.now();

const _footerCopyrightYear = p.footer?.copyright?.year ?? today.year;

/**
 * Some formatted text strings to use below.
 */
const formatted = {

    footer: {
        year: today.year > _footerCopyrightYear
            ? `${_footerCopyrightYear}â€“${today.year}` 
            : _footerCopyrightYear,
    },
};


/* ### FeatureCheck ------------------ */

const featureClasses = support.featureCheck ? FeatureCheck.DEFAULT_CLASSLIST() : [];

---

<html
    { ...p.attrs?.html ?? {} }

    lang={p.lang}
    dir={p.dir ?? 'auto'}

    class:list={ [
        featureClasses,
        p.attrs?.html?.class,
    ] }
>
    <!-- 
        This page includes html generated using
        @maddimathon/utility-astro@0.1.0-alpha.draft

        Author: Maddi Mathon (www.maddimathon.com)
        License: MIT
    -->
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />

        { p.lang && <meta property="og:locale" content={p.lang} /> }

        { slots_render.headOpen ? (
            <!-- SLOT: "head-open" -->
            <slot name="head-open" />
            <!-- /SLOT: "head-open" -->
        ) : <!-- SLOT: "head-open" (empty) / --> }

        <Page_Meta {...p.meta} />

        { slots_render.headClose ? (
            <!-- SLOT: "head-close" -->
            <slot name="head-close" />
            <!-- /SLOT: "head-close" -->
        ) : <!-- SLOT: "head-close" (empty) / --> }
    </head>

    <body 
        { ...p.attrs?.body ?? {} }

        class:list={ [
            `page_${pageSlug}`,
            content.type && `layout_${slugify( content.type )}`,
            p.attrs?.body?.class,
        ] }
    >
        { p.skipLinks && <SkipLinks links={p.skipLinks} /> }

        { slots_render.bodyOpen ? (
            <!-- SLOT: "body-open" -->
            <slot name="body-open" />
            <!-- /SLOT: "body-open" -->
        ) : <!-- SLOT: "body-open" (empty) / --> }

        { support.settings && <SettingsMenu
            {...p.settings}
            accessibilityReportEmail={p.accessibilityReportEmail}
            privacyPolicy={p.privacyPolicy}
        >
            <slot name="settings-menu-open" slot="settings-menu-open" />
            <slot name="settings-menu-close" slot="settings-menu-close" />
        </SettingsMenu> }

        { slots_render.beforeHeader ? (
            <!-- SLOT: "before-header" -->
            <slot name="before-header" />
            <!-- /SLOT: "before-header" -->
        ) : <!-- SLOT: "before-header" (empty) / --> }
        
        { include.header && (
            <header class="site-header">
                { p.header?.title && <SiteTitleTag class="site-title" set:text={p.header.title} /> }
                { p.header?.tagline && <p class="site-tagline" set:text={p.header.tagline} /> }

                { slots_render.header ? (
                    <!-- SLOT: "header" -->
                    <slot name="header" />
                    <!-- /SLOT: "header" -->
                ) : <!-- SLOT: "header" (empty) / --> }
            </header>
        ) }

        { menus.primary && menus.primary.menu.length > 0 && (
            <Fragment>
                { slots_render.beforePrimaryNav ? (
                    <!-- SLOT: "before-primary-nav" -->
                    <slot name="before-primary-nav" />
                    <!-- /SLOT: "before-primary-nav" -->
                ) : <!-- SLOT: "before-primary-nav" (empty) / --> }
                <NavMenu {...menus.primary} class:list="nav-primary" />
                { slots_render.afterPrimaryNav ? (
                    <!-- SLOT: "after-primary-nav" -->
                    <slot name="after-primary-nav" />
                    <!-- /SLOT: "after-primary-nav" -->
                ) : <!-- SLOT: "after-primary-nav" (empty) / --> }
            </Fragment>
        ) }

        { slots_render.afterHeader ? (
            <!-- SLOT: "after-header" -->
            <slot name="after-header" />
            <!-- /SLOT: "after-header" -->
        ) : <!-- SLOT: "after-header" (empty) / --> }
         
         <Content {...content}>
             <slot slot="content-header" name="content-header" />
             <slot slot="before-site-content" name="before-site-content" />
             <slot />
             <slot slot="after-site-content" name="after-site-content" />
             <slot slot="sidebar" name="sidebar" />
         </Content>

         { menus.secondary && menus.secondary.menu.length > 0 && (
             <Fragment>
                 { slots_render.beforeSecondaryNav ? (
                     <!-- SLOT: "before-secondary-nav" -->
                     <slot name="before-secondary-nav" />
                     <!-- /SLOT: "before-secondary-nav" -->
                 ) : <!-- SLOT: "before-secondary-nav" (empty) / --> }
                 <NavMenu {...menus.secondary} class:list="nav-secondary" />
                 { slots_render.afterSecondaryNav ? (
                     <!-- SLOT: "after-secondary-nav" -->
                     <slot name="after-secondary-nav" />
                     <!-- /SLOT: "after-secondary-nav" -->
                 ) : <!-- SLOT: "after-secondary-nav" (empty) / --> }
             </Fragment>
         ) }

        { slots_render.beforeFooter ? (
            <!-- SLOT: "before-footer" -->
            <slot name="before-footer" />
            <!-- /SLOT: "before-footer" -->
        ) : <!-- SLOT: "before-footer" (empty) / --> }
        
        { p.footer && include.footer && (
            <footer class="site-footer">
                { slots_render.footer ? (
                    <!-- SLOT: "footer" -->
                    <slot name="footer" />
                    <!-- /SLOT: "footer" -->
                ) : <!-- SLOT: "footer" (empty) / --> }

                { ( p.footer.designedBy || p.footer.copyright ) && (
                    <p class="disclaimer">
                        
                        { p.footer.copyright && (
                            <span class="copyright"><span class="copyright__copy">&copy;</span> <Fragment set:text={formatted.footer.year} /> {
                                p.footer.copyright.owner
                                ? <Fragment set:text={p.footer.copyright.owner} />
                                : <Fragment set:html={p.footer.copyright.html} />
                            }</span>
                        ) }

                        { ( p.footer.designedBy && p.footer.copyright ) && <br class="disclaimer__divider" /> }

                        { p.footer.designedBy && <Fragment set:html={p.footer.designedBy} /> }
                    </p>
                ) }
            </footer>
        ) }

        { slots_render.afterFooter ? (
            <!-- SLOT: "after-footer" -->
            <slot name="after-footer" />
            <!-- /SLOT: "after-footer" -->
        ) : <!-- SLOT: "after-footer" (empty) / --> }

        { slots_render.bodyClose ? (
            <!-- SLOT: "body-close" -->
            <slot name="body-close" />
            <!-- /SLOT: "body-close" -->
        ) : <!-- SLOT: "body-close" (empty) / --> }

        { slots_render.footerScripts ? (
            <!-- SLOT: "footer-scripts" -->
            <slot name="footer-scripts" />
            <!-- /SLOT: "footer-scripts" -->
        ) : <!-- SLOT: "footer-scripts" (empty) / --> }
        
    </body>
</html>

{ support.featureCheck && <script>
    import { FeatureCheck } from '@maddimathon/utility-sass';

    // run the checks and update class names
    new FeatureCheck().check();
</script> }
 
{ support.elementToggle && <Toggle_Scripts /> }