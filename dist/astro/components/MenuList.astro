---
/**
 * @since 0.1.0-alpha
 * 
 * @packageDocumentation
 */

/* import - types */
import type { HTMLAttributes } from 'astro/types';
import type { Objects } from '@maddimathon/utility-typescript/types';
import type { GenericElementProps } from '../../ts/00-types/index.js';
import type { MenuItem, Props as MenuListProps } from './MenuList.d.ts';

/* import - functions */
import { escapeHTML } from 'astro/runtime/server/escape.js';

/* import - values */

/* import - components */

/* import - layouts */


/* TYPES ===================================== */

export type * from './MenuList.d.ts';


/* PROPS ===================================== */

export interface Props extends Omit<GenericElementProps<MenuListProps, "div">, 'role'> {}

const {
    menu,
    
    class: classList = [],
    separator = null,
    submenu = false,
    ...attributes
}: Props = Astro.props.frontmatter ?? Astro.props;


/* FUNCTIONS ===================================== */

export type UnlabelledMenuItem = Omit<Objects.Classify<MenuItem>, 'href'| 'label'>;

export type ParsedMenuItem_NoHref = UnlabelledMenuItem & {
    html:string;
    href: false;
};

export type ParsedMenuItem_WithHref = UnlabelledMenuItem & {
    html:string;
    href: string;

    'aria-current': HTMLAttributes<'a'>['aria-current'];
    'aria-disabled': HTMLAttributes<'a'>['aria-disabled'];
    target: HTMLAttributes<'a'>['target'];
};

export type ParsedMenuItem = ParsedMenuItem_NoHref | ParsedMenuItem_WithHref;

export function parseItemAttributes(item: MenuItem): ParsedMenuItem {

    const html = escapeHTML(item.label);
    const href = item.href || undefined;
    
    // returns 
    if ( typeof href === 'undefined' || href === undefined ) {

        return {
            html,
            href: false,
            current: item.current,
            external: item.external,
            child: item.child,
        } as const;
    }
    
    return {
        html,
        href,
        current: item.current,
        external: item.external,
        child: item.child,

        target: ( item.href && item.external ) ? '_blank' : undefined,
        'aria-current': ( item.href && item.current ) ? 'page' : undefined,
        'aria-disabled': item.href === false || undefined,
    } as const;
}


/* CONSTANTS ===================================== */

const parsedMenu = menu.map(parseItemAttributes);

---

{ menu && (
    <ul 
        {...attributes} 
        role="menu" 
        class:list={[ {submenu}, classList ]}
    >
        { parsedMenu.map( ( item, index ) =>  ( item.href || item.child ) && (
            <li role="none">
                { item.href ? (
                    <a
                        role="menuitem"
                        href={ item.href }
                        target={ item.target }
                        aria-current={ item['aria-current'] }
                        aria-disabled={ item['aria-disabled'] }
                        set:html={ item.html }
                    /> 
                ) : item.child?.length && (
                    <span
                        role="menuitem"
                        set:html={ item.html }
                    />
                ) }
                { item.child?.length && <Astro.self menu={ item.child } submenu={ true } /> }
            </li>
            <Fragment set:html={ separator && index < menu.length && separator } />
        ) )  }
    </ul>
) }