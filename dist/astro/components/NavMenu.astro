---
/**
 * @since 0.1.0-alpha
 *
 * @packageDocumentation
 */

/* import - types */
import type { ArrayItem } from '@maddimathon/utility-typescript/types';
import type { GenericElementProps } from '../../ts/00-types/index.ts';
import type { MenuItem } from './MenuList.astro';

/* import - functions */
import { escRegExp } from '@maddimathon/utility-typescript/functions';
import { escRegExpURL } from '../../ts/01-functions/index.js';
import { absoluteInternalURL } from '../functions/index.js';

/* import - values */
import { site as config_site } from 'astro:config/client';

/* import - components */
import MenuList from './MenuList.astro';

/* import - layouts */

/* TYPES ===================================== */

/**
 * Input props for the NavMenu component.
 *
 * @since 0.1.0-alpha
 * @since 0.1.0-alpha.17 â€” Moved to component file.
 */
export interface NavMenuProps {
    /**
     * Screen-reader label for the navigation menu.
     */
    'aria-label': string;

    'convertHrefStringsToAbsolute'?: boolean | null;

    /**
     * Unique id attr.
     */
    'id': string;

    /**
     * To pass to the `MenuList` component, see that component for details.
     *
     * Must have at least one item.
     */
    'menu': (Omit<MenuItem, 'child' | 'href'> & {
        /**
         * If false, the link prints without href and with aria-disabled.  If
         * null or undefined, the list item is not printed at all.
         *
         * If a string, this is assumed to be a path relative to the home page.
         */
        href?: URL | string | false;

        /**
         * Child menu items, if any.
         */
        child?: Props['menu'];
    })[];
}

/* PROPS ===================================== */

export interface Props extends GenericElementProps<NavMenuProps, 'nav'> {}

const {
    class: classList = [],
    convertHrefStringsToAbsolute = null,
    id,
    menu,
    ...attributes
}: Props = Astro.props.frontmatter ?? Astro.props;

/* FUNCTIONS ===================================== */

/**
 * Converts an item input to the nav params to one for the
 */
export function parseMenuItem(
    currentURL: URL,
    item: ArrayItem<NavMenuProps['menu']>,
    convertHrefStringsToAbsolutePath: boolean | null = null,
): MenuItem {
    /**
     * The regex representing the current page's url (used to check for
     * isCurrentPage value).
     */
    const isCurrentPage_regex = {
        /**
         * To use on string values, assuming they are paths relative to the root.
         */
        string: new RegExp(
            `^(${escRegExp(
                absoluteInternalURL(currentURL, currentURL.pathname),
            )})\/?$`,
            'gi',
        ),

        /**
         * To use on URL.toString() values.
         */
        url: new RegExp(
            `^(${escRegExpURL(
                currentURL.toString().replace(/\/$/gi, '/'),
            )}|${escRegExpURL(
                config_site +
                    absoluteInternalURL(
                        currentURL,
                        currentURL.pathname,
                    ).replace(/\/$/gi, '/'),
            )})\/?$`,
            'gi',
        ),
    };

    let isCurrentPage: boolean = item.current ?? false;

    let href: MenuItem['href'];

    switch (typeof item.href) {
        case 'object':
            // breaks
            if (item.href === null) {
                break;
            }

            href = item.href.toString();

            isCurrentPage =
                isCurrentPage || href.match(isCurrentPage_regex.url) !== null;
            break;

        case 'string':
            href = item.href;

            if (
                convertHrefStringsToAbsolutePath ??
                href.match(/^(\.\.?\/|\/|[a-z]+:\/\/)/) === null
            ) {
                href = absoluteInternalURL(currentURL, item.href);
            }
            isCurrentPage =
                isCurrentPage ||
                href.match(isCurrentPage_regex.string) !== null;
            break;

        default:
            href = item.href;
            break;
    }

    let child: MenuItem['child'];

    if (item.child?.length) {
        child = [...item.child].map((_item) =>
            parseMenuItem(currentURL, _item, convertHrefStringsToAbsolutePath),
        );
    }

    return {
        ...item,
        href,
        current: isCurrentPage || null,
        child,
    };
}

/* CONSTANTS ===================================== */

const parsedMenu = [...menu].map((_item) =>
    parseMenuItem(Astro.url, _item, convertHrefStringsToAbsolute),
);
---

<nav
    {...attributes}
    id={id}
    class:list={classList}
    role='navigation'
>
    <MenuList menu={parsedMenu} />
</nav>
