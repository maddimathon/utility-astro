---
/**
 * @since ___PKG_VERSION___
 *
 * @packageDocumentation
 */

/* import - types */

/* import - functions */
import { getCollection } from 'astro:content';
import { escapeHTML } from 'astro/runtime/server/escape.js';
import * as YAML from 'yaml';

import { absoluteInternalURL } from '../../astro/functions';
import { 
    kindIconName, 
    kindIconHTML,
    Project,
    Project_Tree, 
    sortReflections,
} from '../../ts/typedoc/index.js';

/* import - values */

/* import - components */
import NestedList, { type NestedListItem } from '../../astro/components/NestedList.astro';
import ToggleDump from '../components/ToggleDump.astro';

/* import - layouts */
import DocsPage from '../layouts/DocsPage.astro';

/* TYPES ===================================== */

/* FUNCTIONS ===================================== */

/* CONSTANTS ===================================== */

const rawCollection = await getCollection('api');

const project = new Project(rawCollection);

const projectJSON = project.toJSON();

const sortingIndexes = Object.values(project.reflections)
    .map(_refl=>({
        sortingIndex: _refl.sortingIndex,
        typeDocId: _refl.typeDocId,
    }))
    .sort( ( a, b ) => sortReflections(
        project.reflections[a.typeDocId],
        project.reflections[b.typeDocId],
    ) );

export function treeListToNested(
    treeList:Project_Tree.NestedListItem[],
): NestedListItem[] {

    return treeList.map( (_item): NestedListItem => {

        let html = kindIconHTML(kindIconName(_item.kind)) + escapeHTML(_item.title);
        
        if ( _item.href ) {
            html = `<a href="${ absoluteInternalURL(Astro.url, 'api/' + _item.href) }">${ html }</a>`;
        }

        // returns
        if ( _item.children ) {

            return {
                html,
                children:treeListToNested(_item.children),
            };
        }
        
        return {html};
    } )
}
    
const treeList = treeListToNested(Project_Tree.toNestedList(project.tree.tree,true));
---

<DocsPage title='Javascript Documentation'>
    <ToggleDump title='NestedList — treeList'>
        <NestedList list={treeList} />
    </ToggleDump>
    <hr />

    <ToggleDump
        title='Project.reflections'
        lang='yaml'
        code={YAML.stringify(projectJSON.reflections)}
    />
    <hr />

    <ToggleDump
        title='Project.reflectionGroups'
        lang='yaml'
        code={YAML.stringify(projectJSON.reflectionGroups)}
    />
    <hr />
    <ToggleDump title='Project.reflectionGroups (details)'>
        <h3 set:text={'All'} />
        <ul>
            <li>count: <Fragment set:text={Object.keys(projectJSON.reflections).length} /></li>
        </ul>
        {
            (
                Object.keys(
                    projectJSON.reflectionGroups
                ) as (keyof typeof projectJSON.reflectionGroups)[]
            ).map((groupKey) => Array.isArray(projectJSON.reflectionGroups[groupKey]) && (
                <h3 set:text={groupKey} />
                <ul>
                    <li>count: <Fragment set:text={projectJSON.reflectionGroups[groupKey].length} /></li>
                </ul>
            ))
        }
    </ToggleDump>
    <hr />

    <ToggleDump
        title='Project.pages'
        lang='yaml'
        code={YAML.stringify(projectJSON.pages)}
    />
    <hr />

    <ToggleDump
        title='Project.tree'
        lang='yaml'
        code={YAML.stringify(project.tree)}
    />
    <hr />

    <ToggleDump
        title='sortingIndexes'
        lang='yaml'
        code={YAML.stringify(sortingIndexes)}
    />
    <hr />

    <!-- <ToggleDump title='NestedList — collectionTree.exportList()'>
        <NestedList list={Object.values(collectionTree.exportList())} />
    </ToggleDump>
    <hr />
    <ToggleDump
        title='collectionTree.exportMap()'
        lang='yaml'
        code={YAML.stringify(collectionTree.exportMap())}
    />
    <hr />
    <ToggleDump
        title='collectionTree.map'
        lang='yaml'
        code={YAML.stringify(collectionTree.map)}
    />
    <hr />
    <ToggleDump
        title='collectionTree.pages'
        lang='yaml'
        code={YAML.stringify(collectionTree.pages)}
    />
    <hr /> -->
</DocsPage>
